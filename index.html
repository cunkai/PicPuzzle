<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量读取本地照片并切割</title>
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    <meta property="og:image" content="https://gitee.com/cunkai/Midjourney-1-to-4/raw/master/favicon.png" />
    <style>
        body {
            background-color: #dedec7;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192' viewBox='0 0 192 192'%3E%3Cpath fill='%23000001' fill-opacity='0.06' d='M192 15v2a11 11 0 0 0-11 11c0 1.94 1.16 4.75 2.53 6.11l2.36 2.36a6.93 6.93 0 0 1 1.22 7.56l-.43.84a8.08 8.08 0 0 1-6.66 4.13H145v35.02a6.1 6.1 0 0 0 3.03 4.87l.84.43c1.58.79 4 .4 5.24-.85l2.36-2.36a12.04 12.04 0 0 1 7.51-3.11 13 13 0 1 1 .02 26 12 12 0 0 1-7.53-3.11l-2.36-2.36a4.93 4.93 0 0 0-5.24-.85l-.84.43a6.1 6.1 0 0 0-3.03 4.87V143h35.02a8.08 8.08 0 0 1 6.66 4.13l.43.84a6.91 6.91 0 0 1-1.22 7.56l-2.36 2.36A10.06 10.06 0 0 0 181 164a11 11 0 0 0 11 11v2a13 13 0 0 1-13-13 12 12 0 0 1 3.11-7.53l2.36-2.36a4.93 4.93 0 0 0 .85-5.24l-.43-.84a6.1 6.1 0 0 0-4.87-3.03H145v35.02a8.08 8.08 0 0 1-4.13 6.66l-.84.43a6.91 6.91 0 0 1-7.56-1.22l-2.36-2.36A10.06 10.06 0 0 0 124 181a11 11 0 0 0-11 11h-2a13 13 0 0 1 13-13c2.47 0 5.79 1.37 7.53 3.11l2.36 2.36a4.94 4.94 0 0 0 5.24.85l.84-.43a6.1 6.1 0 0 0 3.03-4.87V145h-35.02a8.08 8.08 0 0 1-6.66-4.13l-.43-.84a6.91 6.91 0 0 1 1.22-7.56l2.36-2.36A10.06 10.06 0 0 0 107 124a11 11 0 0 0-22 0c0 1.94 1.16 4.75 2.53 6.11l2.36 2.36a6.93 6.93 0 0 1 1.22 7.56l-.43.84a8.08 8.08 0 0 1-6.66 4.13H49v35.02a6.1 6.1 0 0 0 3.03 4.87l.84.43c1.58.79 4 .4 5.24-.85l2.36-2.36a12.04 12.04 0 0 1 7.51-3.11A13 13 0 0 1 81 192h-2a11 11 0 0 0-11-11c-1.94 0-4.75 1.16-6.11 2.53l-2.36 2.36a6.93 6.93 0 0 1-7.56 1.22l-.84-.43a8.08 8.08 0 0 1-4.13-6.66V145H11.98a6.1 6.1 0 0 0-4.87 3.03l-.43.84c-.79 1.58-.4 4 .85 5.24l2.36 2.36a12.04 12.04 0 0 1 3.11 7.51A13 13 0 0 1 0 177v-2a11 11 0 0 0 11-11c0-1.94-1.16-4.75-2.53-6.11l-2.36-2.36a6.93 6.93 0 0 1-1.22-7.56l.43-.84a8.08 8.08 0 0 1 6.66-4.13H47v-35.02a6.1 6.1 0 0 0-3.03-4.87l-.84-.43c-1.59-.8-4-.4-5.24.85l-2.36 2.36A12 12 0 0 1 28 109a13 13 0 1 1 0-26c2.47 0 5.79 1.37 7.53 3.11l2.36 2.36a4.94 4.94 0 0 0 5.24.85l.84-.43A6.1 6.1 0 0 0 47 84.02V49H11.98a8.08 8.08 0 0 1-6.66-4.13l-.43-.84a6.91 6.91 0 0 1 1.22-7.56l2.36-2.36A10.06 10.06 0 0 0 11 28 11 11 0 0 0 0 17v-2a13 13 0 0 1 13 13c0 2.47-1.37 5.79-3.11 7.53l-2.36 2.36a4.94 4.94 0 0 0-.85 5.24l.43.84A6.1 6.1 0 0 0 11.98 47H47V11.98a8.08 8.08 0 0 1 4.13-6.66l.84-.43a6.91 6.91 0 0 1 7.56 1.22l2.36 2.36A10.06 10.06 0 0 0 68 11 11 11 0 0 0 79 0h2a13 13 0 0 1-13 13 12 12 0 0 1-7.53-3.11l-2.36-2.36a4.93 4.93 0 0 0-5.24-.85l-.84.43A6.1 6.1 0 0 0 49 11.98V47h35.02a8.08 8.08 0 0 1 6.66 4.13l.43.84a6.91 6.91 0 0 1-1.22 7.56l-2.36 2.36A10.06 10.06 0 0 0 85 68a11 11 0 0 0 22 0c0-1.94-1.16-4.75-2.53-6.11l-2.36-2.36a6.93 6.93 0 0 1-1.22-7.56l.43-.84a8.08 8.08 0 0 1 6.66-4.13H143V11.98a6.1 6.1 0 0 0-3.03-4.87l-.84-.43c-1.59-.8-4-.4-5.24.85l-2.36 2.36A12 12 0 0 1 124 13a13 13 0 0 1-13-13h2a11 11 0 0 0 11 11c1.94 0 4.75-1.16 6.11-2.53l2.36-2.36a6.93 6.93 0 0 1 7.56-1.22l.84.43a8.08 8.08 0 0 1 4.13 6.66V47h35.02a6.1 6.1 0 0 0 4.87-3.03l.43-.84c.8-1.59.4-4-.85-5.24l-2.36-2.36A12 12 0 0 1 179 28a13 13 0 0 1 13-13zM84.02 143a6.1 6.1 0 0 0 4.87-3.03l.43-.84c.8-1.59.4-4-.85-5.24l-2.36-2.36A12 12 0 0 1 83 124a13 13 0 1 1 26 0c0 2.47-1.37 5.79-3.11 7.53l-2.36 2.36a4.94 4.94 0 0 0-.85 5.24l.43.84a6.1 6.1 0 0 0 4.87 3.03H143v-35.02a8.08 8.08 0 0 1 4.13-6.66l.84-.43a6.91 6.91 0 0 1 7.56 1.22l2.36 2.36A10.06 10.06 0 0 0 164 107a11 11 0 0 0 0-22c-1.94 0-4.75 1.16-6.11 2.53l-2.36 2.36a6.93 6.93 0 0 1-7.56 1.22l-.84-.43a8.08 8.08 0 0 1-4.13-6.66V49h-35.02a6.1 6.1 0 0 0-4.87 3.03l-.43.84c-.79 1.58-.4 4 .85 5.24l2.36 2.36a12.04 12.04 0 0 1 3.11 7.51A13 13 0 1 1 83 68a12 12 0 0 1 3.11-7.53l2.36-2.36a4.93 4.93 0 0 0 .85-5.24l-.43-.84A6.1 6.1 0 0 0 84.02 49H49v35.02a8.08 8.08 0 0 1-4.13 6.66l-.84.43a6.91 6.91 0 0 1-7.56-1.22l-2.36-2.36A10.06 10.06 0 0 0 28 85a11 11 0 0 0 0 22c1.94 0 4.75-1.16 6.11-2.53l2.36-2.36a6.93 6.93 0 0 1 7.56-1.22l.84.43a8.08 8.08 0 0 1 4.13 6.66V143h35.02z'%3E%3C/path%3E%3C/svg%3E");
            font-family: Arial, sans-serif;
            color: #333;
            margin: 1vw;
            padding: 1vw;
        }

        .container {
            max-width: 80%;
            margin: 0 auto;
            padding: 10%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .input-container {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .midjourney {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3vw;
            font-weight: bold;
            text-transform: uppercase;
            color: #03b4ab;
            margin-bottom: 10%;
            margin-top: 10%;
        }

        .midjourney i {
            margin-right: 10px;
        }

        .preview-image {
            margin: 10px;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            cursor: pointer;
        }

        .preview-image:hover {
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.5);
        }

        h1 {
            font-size: 5vw;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 1vw;
            font-size: 8vw;
            color: #fff;
            background-color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 3vh;
            margin-bottom: 3vh;
        }

        button:hover {
            background-color: #555;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5vw;
            font-weight: bold;
            color: #fff;
            text-align: center;
            display: none;
            z-index: 1000;
        }

        .error {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 3vw;
            color: #fff;
            background-color: rgb(0, 255, 34);
            z-index: 1000;
            display: none;
        }

        /* 竖屏样式 */
        @media screen and (orientation:portrait) {
            .midjourney {
                font-size: 13vw;
                margin-bottom: 10vh;
                margin-top: 20vh;
            }


            .chinaMJ {
                display: flex;
                width: 100%;
                justify-content: center;
                font-size: 3vw;
                margin: 1vh;
            }

            h1 {
                font-size: 4vw;
                margin-bottom: 10px;
            }

            button {
                font-size: 8vw;
                margin-top: 5vh;
                margin-bottom: 5vh;
            }

            .submit-btn-small {
                font-size: 3vw;
                margin-top: 0.3vh;
            }

            label[id="image-num-input"] {
                font-size: 5vw;
                margin-right: 1vw;
                margin-left: 1vw;
            }


            input[type="number"] {
                padding: 10px 20px;
                border-radius: 1vw;
                font-size: 5vw;
                border: none;
                background-color: #fff;
                width: 8vw;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
                /* line-height: 1; */
                /* 重置默认行高 */
                text-align: center;
                margin: 1vw;
            }

            #square-container {
                position: relative;
                width: 40px;
                height: 40px;
                border: 1px solid black;
                margin-left: 1vw;
            }

            .line {
                position: absolute;
                background-color: rgba(0, 0, 0, 0.5);
            }

            .horizontal-line {
                width: 100%;
                height: 1px;
            }

            .vertical-line {
                width: 1px;
                height: 100%;
            }
        }

        /* 横屏样式 */
        @media screen and (orientation:landscape) {
            .midjourney {
                font-size: 10vw;
                margin-bottom: 3vh;
                margin-top: 2vh;
            }


            .chinaMJ {
                display: flex;
                width: 100%;
                justify-content: center;
                font-size: 1vw;
                margin: 1vh;
            }

            h1 {
                font-size: 5vw;
                margin-bottom: 20px;
            }



            button {
                font-size: 3vw;
                margin-top: 3vh;
                margin-bottom: 3vh;
            }

            .submit-btn-small {
                font-size: 1vw;
                margin-top: 0.5vh;
            }

            label[id="image-num-input"] {
                font-size: 3vw;
                margin-right: 1vw;
                margin-left: 1vw;
            }

            input[type="number"] {
                border-radius: 1vw;
                font-size: 3vw;
                border: none;
                background-color: #fff;
                width: 10vw;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
                align-items: center;
                text-align: center;
                margin: 1vw;
            }

            #square-container {
                position: relative;
                width: 40px;
                height: 40px;
                border: 1px solid black;
                margin-left: 1vw;
            }

            .line {
                position: absolute;
                background-color: rgba(0, 0, 0, 0.5);
            }

            .horizontal-line {
                width: 100%;
                height: 1px;
            }

            .vertical-line {
                width: 1px;
                height: 100%;
            }
        }
    </style>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?7361a42ea4b277a217e491241146f3c7";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>

<body onload="init()">
    <div class="container">
        <div class="midjourney"><i class="fas fa-font"></i> 图片切割机</div>

        <div class="input-container">
            <label for="vertical-cuts" id="image-num-input">横</label>
            <input type="number" id="vertical-cuts" min="1" value="2">

            <label for="horizontal-cuts" id="image-num-input">竖</label>
            <input type="number" id="horizontal-cuts" min="1" value="2">

            <!-- 正方形预览 -->
            <div id="square-container">
                <div id="square">
                    <!-- 在这里添加虚线 -->
                </div>
            </div>

            <!-- <label for="image-num-input">切割成</label>
            <select type="number" id="image-num-input">
                <option value="4" selected>4</option>
                <option value="9">9</option>
                <option value="16">16</option>
                <option value="25">25</option>
                <option value="36">36</option>
                <option value="49">49</option>
                <option value="64">64</option>
                <option value="81">81</option>
            </select>

            <label for="image-num-input">张</label> -->
        </div>

        <button id="submit-btn">
            <div>选择图片</div>
            <div class="submit-btn-small">可以选择多张图</div>
        </button>

        <!-- <a class="chinaMJ" href="https://poe.com/MJEN">MidJourney[ 英文 ]提示词网站: https://poe.com/MJEN </a>
        <a class="chinaMJ" href="https://poe.com/MJCN">MidJourney[ 中文 ]提示词网站: https://poe.com/MJCN </a> -->
        <a class="chinaMJ" href="https://www.u3dx.com">作者主页</a>

    </div>

    <!-- 新增 HTML -->
    <div class="overlay"></div>
    <div class="loading">正在处理中...</div>
    <div class="error"></div>

    <script src="jszip.min.js"></script>
    <script>
        if (/(iPhone|iPad|iPod|iOS|Android)/i.test(navigator.userAgent) && /MicroMessenger/i.test(navigator.userAgent)) {
            const overlay = document.querySelector('.overlay');
            const arrow = document.createElement('div');
            arrow.style.cssText = `
            position: fixed;
            top: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background-color: #fff;
            border-radius: 50%;
            font-size: 5vw;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotate(-45deg);
            z-index: 1001;
        `;
            arrow.innerHTML = '&rarr;';
            const message = document.createElement('div');
            message.innerText = '点击右上···\n用浏览器打开';
            message.style.cssText = `
            position: fixed;
            top: 40px;
            right: 96px;
            padding: 30px;
            background-color: #fff;
            color: #333;
            font-size: 10vw;
            border-radius: 4vw;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 1001;
        `;
            document.body.appendChild(arrow);
            document.body.appendChild(message);
            overlay.style.display = 'block';
        }

        const submitBtn = document.getElementById('submit-btn');
        // 用于存储切割后的所有图片
        let imageArr = [];
        // 新增代码：添加用于处理文件的函数
        const input = document.createElement('input');
        //横向和竖线切割的值
        let horizontalCuts = 1;
        let verticalCuts = 1;
        const inputHorizontal = document.getElementById('horizontal-cuts');
        const inputVertical = document.getElementById('vertical-cuts');

        //让正方形显示切割预览
        function squareChange() {
            horizontalCuts = parseInt(document.getElementById('horizontal-cuts').value);
            if(horizontalCuts<1)
            {
                horizontalCuts = 1;
            }
            verticalCuts = parseInt(document.getElementById('vertical-cuts').value);
            if(verticalCuts<1)
            {
                verticalCuts = 1;
            }

            const square = document.getElementById('square');
            square.innerHTML = '';

            for (let i = 1; i < horizontalCuts; i++) {
                const line = document.createElement('div');
                line.className = 'line horizontal-line';
                line.style.top = `${(i / horizontalCuts) * 100}%`;
                square.appendChild(line);
            }

            for (let i = 1; i < verticalCuts; i++) {
                const line = document.createElement('div');
                line.className = 'line vertical-line';
                line.style.left = `${(i / verticalCuts) * 100}%`;
                square.appendChild(line);
            }
        }

        inputHorizontal.addEventListener('change', function () {
            if (inputHorizontal.value < 1) {
                alert("竖向应该至少有1张(图片本身)");
                inputHorizontal.value = 1;
            }
            squareChange();
        });
        inputVertical.addEventListener('change', function () {
            if (inputVertical.value < 1) {
                alert("横向应该至少有1张(图片本身)");
                inputVertical.value = 1;
            }
            squareChange();
        });



        submitBtn.addEventListener('click', () => {
            imageArr = [];
            input.type = 'file';
            input.multiple = true;
            input.value = '';
            if (input.changeListener) {
                input.removeEventListener('change', input.changeListener);
            }
            input.changeListener = () => {
                handleFiles(input.files);
            };

            input.addEventListener('change', input.changeListener);

            input.click();
        });

        function init() {
            squareChange();
        }

        function handleFiles(files) { // 接收用户输入的切割张数
            showOverlay();
            showError('');
            showMessage('正在切割中...');
            for (let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                reader.readAsDataURL(files[i]);
                reader.onload = function (event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        processImage(img, files[i].name); //将图片传入处理函数
                    }
                };
            }
        }

        // 对每张照片进行处理的函数
        function processImage(img, fileName) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');


            canvas.width = Math.floor(img.width / verticalCuts);
            canvas.height = Math.floor(img.height / horizontalCuts);
            // console.log(horizontalCuts);

            for (let i = 0; i < verticalCuts; i++) {
                for (let j = 0; j < horizontalCuts; j++) {
                    // console.log(i+"   "+j);
                    ctx.drawImage(img, i * canvas.width, j * canvas.height, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
                    saveImage(canvas, (i * horizontalCuts + j + 1) + "_" + new Date().getTime() + "_" + fileName);// 修改文件名
                }
            }
        }


        // 保存图像的函数

        function saveImage(canvas, name) {
            const zip = new JSZip();
            showMessage('压缩图片到zip文件');
            canvas.toBlob(blob => {
                imageArr.push({ name: name, blob: blob });
                let inputLength = input.files.length * horizontalCuts * verticalCuts;
                // console.log(imageArr.length + " =?= " + inputLength);
                if (imageArr.length === inputLength) { // 根据用户输入的切割张数计算总张数
                    for (let i = 0; i < imageArr.length; i++) {
                        zip.file(imageArr[i].name, imageArr[i].blob);
                    }
                    zip.generateAsync({ type: 'blob' })
                        .then(blob => {
                            const link = document.createElement('a');
                            link.download = '切割图' + inputLength + '张_' + new Date().getTime() + '.zip';
                            link.href = URL.createObjectURL(blob);
                            link.click();
                            hideOverlay();
                            showMessage('完成！');
                        })
                        .catch(error => {
                            showError('出错了，请重试');
                            console.error(error);
                        });
                }
            });
        }



        /* 新增函数 */
        function showOverlay() {
            const overlay = document.querySelector('.overlay');
            const loading = document.querySelector('.loading');
            overlay.style.display = 'block';
            loading.style.display = 'block';
        }

        function hideOverlay() {
            const overlay = document.querySelector('.overlay');
            const loading = document.querySelector('.loading');
            overlay.style.display = 'none';
            loading.style.display = 'none';
        }

        function showMessage(message) {
            const error = document.querySelector('.error');
            error.textContent = message;
            error.style.display = 'block';
            setTimeout(() => {
                error.style.display = 'none';
            }, 3000);
        }

        function showError(error) {
            const errorEl = document.querySelector('.error');
            errorEl.textContent = error;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 3000);
        }

    </script>
</body>

</html>